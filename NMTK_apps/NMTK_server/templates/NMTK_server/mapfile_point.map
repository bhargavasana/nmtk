{% load url from future %}{% load static %}
MAP
  NAME Results_WMS
  UNITS dd
#  EXTENT -8200000 4990000 -7800000 6050000
  STATUS ON
  SIZE 512 512
  IMAGECOLOR 255 255 255
  IMAGETYPE PNG
  

  # This is for the WMS requests
  OUTPUTFORMAT
    NAME PNG
    DRIVER 'GD/PNG'
    MIMETYPE 'image/png'
    IMAGEMODE RGBA
    EXTENSION "png"
    TRANSPARENT ON
  END

  OUTPUTFORMAT
    NAME "json"
    DRIVER "TEMPLATE"
    FORMATOPTION "FILE={{mapserver_template}}"
    MIMETYPE "application/json"
  END

  PROJECTION
   "init=epsg:4326"
  END

  WEB
    IMAGEPATH "/tmp/"
    IMAGEURL "/tmp/"
    LOG "/tmp/mapserv.log"

    METADATA
      wms_feature_info_mime_type "application/json"
      ows_feature_info_mime_type "application/json"
      wms_include_items "application/json"
      "wms_enable_request" "*"
      "ows_enable_request" "*"
      "wms_include_items" "text/html"
      WMS_TITLE "Incidents"
      WMS_ABSTRACT "NMTK Tool Results"
      WMS_ACCESSCONSTRAINTS "none"
      WMS_ONLINERESOURCE "{% url 'api_datafile_wms' api_name='v1' resource_name='datafile' pk=datafile.pk %}"
      WMS_SRS "EPSG:3857 EPSG:4326"
    END
  END

  SYMBOL
    NAME "triangle"
    TYPE vector
    POINTS
      0 4
      1 2
      2 0
      3 2
      4 4
      0 4
    END
    FILLED TRUE
  END

  SYMBOL
    NAME "circle"
    TYPE ELLIPSE
    POINTS
     10 10
    END
    FILLED TRUE
  END

  #
  # BEGIN LAYER DESCRIPTIONS
  #

  LAYER
    NAME "results"
    CONNECTIONTYPE OGR
    CONNECTION "{{datafile.sqlite_db.path}}"
    DATA "{{datafile.pk}}_results"
#    DATA 'SELECT nmtk_geometry,* FROM "{{datafile.pk}}_results"'
    TYPE POINT
#    STATUS ON
    DUMP TRUE
    PROJECTION
      "init=epsg:4326"
    END
    TOLERANCE 4
    TRANSPARENCY ALPHA
    TEMPLATE "results.html"
    METADATA
     "wms_getfeature_formatlist" "gml,json"
      WMS_TITLE "Results"
      WMS_ABSTRACT "Results from NMTK Tool"
      WMS_SRS "EPSG:4326"
      WMS_GROUP_TITLE "Results"
      GML_INCLUDE_ITEMS "nmtk_feature_id"
    END
    
    
    {% for color in colors %}
    CLASS
      NAME "Results between {{color.low}} and {{color.high}}"
      EXPRESSION ([result] >= {{color.low}} and [result] <= {{color.high}}) 
      STYLE
        COLOR {{color.r}} {{color.g}} {{color.b}}
  	    SYMBOL "circle"
	    OUTLINECOLOR 0 0 0
        ANTIALIAS TRUE
      END # END STYLE
    END
    {% endfor %}

  END

  LAYER
    NAME "highlight"
    CONNECTIONTYPE OGR
    CONNECTION "{{datafile.sqlite_db.path}}"
    # Generate a query to get those features that are requested for highlighting.
    DATA 'SELECT nmtk_geometry FROM "{{datafile.pk}}_results" WHERE nmtk_id in (%ids%)'
    VALIDATION
      "ids" "[0-9,]+"
    END
    TYPE POINT
#    STATUS ON
    DUMP TRUE
    PROJECTION
      "init=epsg:4326"
    END
    TRANSPARENCY ALPHA
    CLASS
      NAME "Selected Results"
      STYLE
        COLOR 0 0 0
  	    SYMBOL "circle"
	    OUTLINECOLOR 0 0 0
        ANTIALIAS TRUE
      END # END STYLE
    END

    METADATA
      WMS_TITLE "Highlights"
      WMS_ABSTRACT "Selected results"
      WMS_SRS "EPSG:4326"
      WMS_GROUP_TITLE "Highlights"
      GML_INCLUDE_ITEMS "all"
    END
  END

END

